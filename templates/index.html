<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Sentiment Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            text-align: left;
            font-size: 1.2em;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1000px;
            margin-left: 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.1);
        }
        .search-container {
            margin-bottom: 20px;
        }
        input, button {
            font-size: 1.2em;
            padding: 10px;
            margin: 10px;
        }
        .info-section {
            text-align: left;
            margin: 20px auto;
            max-width: 900px;
        }
        canvas {
            max-width: 100%;
            margin: 20px auto;
        }
        #error-message {
            color: red;
            font-size: 1.2em;
            display: none;
        }
        .chart-container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            flex-direction: column;
        }
        .chart-container canvas {
        height: 10cm !important;
    }
    </style>
</head>
<body>
    <div class="container">
        <h1>Review Sentiment Analysis</h1>
        <div class="search-container">
            <input type="text" id="productSearch" placeholder="Enter ASIN">
            <button onclick="fetchProductData()">Search</button>
        </div>
        <p id="error-message"></p>

        <div class="info-section" id="output-section" style="display: none;">
            <h2>Product Name: <span id="productName">Loading...</span></h2>
            <h3>Total Reviews Scraped: <span id="totalReviews">Loading...</span></h3>

            <h2>Overall Review Score (Median Score)</h2>
            <p id="medianScore">Loading...</p>

            <h2>Top 10 Adjectives</h2>
            <ul id="topAdjectives">Loading...</ul>

            <h2>Competitor Mentions</h2>
            <ul id="competitorMentions">Loading...</ul>

            <h2>Review Sentiment Trend</h2>
            <div class="chart-container">
                <canvas id="reviewTrendChart"></canvas>
            </div>

            <h2>Positive vs Negative vs Neutral Mentions</h2>
            <div class="chart-container">
                <canvas id="sentimentBreakdownChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let reviewTrendChart, sentimentBreakdownChart;

        async function fetchProductData() {
            const asin = document.getElementById("productSearch").value.trim();
            if (!asin) {
                showError("Please enter a valid ASIN.");
                return;
            }

            console.log("🔍 Fetching reviews for ASIN:", asin);

            document.getElementById("error-message").style.display = "none";
            try {
                const response = await fetch(`http://127.0.0.1:5001/fetch_reviews?asin=${asin}`);
                const data = await response.json();

                console.log("✅ API Response:", data);

                if (!data || Object.keys(data).length === 0) {
                    throw new Error("Empty API response.");
                }

                if (data.error) throw new Error(data.error);

                document.getElementById("output-section").style.display = "block";

                document.getElementById("productName").innerText = data.product_name || "Unknown Product";
                document.getElementById("totalReviews").innerText = data.total_reviews || "0";
                document.getElementById("medianScore").innerText = data.median_score !== null ? data.median_score.toFixed(2) : "N/A";

                document.getElementById("topAdjectives").innerHTML = (data.top_adjectives && data.top_adjectives.length) 
                    ? data.top_adjectives.map(([adj, count]) => `<li>${adj} (${count})</li>`).join("") 
                    : "<li>No adjectives found.</li>";

                document.getElementById("competitorMentions").innerHTML = (data.competitor_mentions && Object.keys(data.competitor_mentions).length) 
                    ? Object.entries(data.competitor_mentions).map(([brand, count]) => `<li>${brand} (${count})</li>`).join("") 
                    : "<li>No competitor mentions found.</li>";

                updateCharts(data);
            } catch (error) {
                console.error("❌ Error fetching data:", error);
                showError(error.message);
            }
        }

        function showError(message) {
            document.getElementById("error-message").innerText = message;
            document.getElementById("error-message").style.display = "block";
            document.getElementById("output-section").style.display = "none";
        }

        function updateCharts(data) {
            console.log("📊 Updating charts...");

            if (reviewTrendChart) reviewTrendChart.destroy();
            if (sentimentBreakdownChart) sentimentBreakdownChart.destroy();

            const dateSentimentMap = {};
            data.review_dates.forEach((date, index) => {
                if (!dateSentimentMap[date]) {
                    dateSentimentMap[date] = { positive: 0, negative: 0, neutral: 0 };
                }
                dateSentimentMap[date].positive += data.positive_scores[index] || 0;
                dateSentimentMap[date].negative += data.negative_scores[index] || 0;
                dateSentimentMap[date].neutral += data.neutral_scores[index] || 0;
            });

            const uniqueDates = Object.keys(dateSentimentMap).sort();
            const positiveScoresPerDay = uniqueDates.map(date => dateSentimentMap[date].positive);
            const negativeScoresPerDay = uniqueDates.map(date => dateSentimentMap[date].negative);
            const neutralScoresPerDay = uniqueDates.map(date => dateSentimentMap[date].neutral);

            console.log("📊 Creating Review Sentiment Trend Chart...");
            reviewTrendChart = new Chart(document.getElementById("reviewTrendChart"), {
                type: "line",
                data: {
                    labels: uniqueDates,
                    datasets: [
                        { label: "Positive Sentiment", data: positiveScoresPerDay, borderColor: "green", backgroundColor: "rgba(0, 255, 0, 0.2)", fill: true },
                        { label: "Negative Sentiment", data: negativeScoresPerDay, borderColor: "red", backgroundColor: "rgba(255, 0, 0, 0.2)", fill: true },
                        { label: "Neutral Sentiment", data: neutralScoresPerDay, borderColor: "blue", backgroundColor: "rgba(0, 0, 255, 0.2)", fill: true }
                    ]
                }
            });

            console.log("📊 Creating Sentiment Breakdown Chart...");
            sentimentBreakdownChart = new Chart(document.getElementById("sentimentBreakdownChart"), {
                type: "pie",
                data: { labels: ["Positive", "Negative", "Neutral"], datasets: [{ data: [data.positive_percentage, data.negative_percentage, data.neutral_percentage], backgroundColor: ["green", "red", "blue"] }] },
                options: { plugins: { tooltip: { callbacks: { label: tooltipItem => tooltipItem.raw.toFixed(2) + "%" } } } }
            });
        }
    </script>
</body>
</html>
